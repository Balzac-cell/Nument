import streamlit as st
import requests
import datetime


def app():
    if "page" not in st.session_state:
        st.session_state["page"] = "IntroFormulaireComplet"  # État par défaut

    # Vérifie que l'UUID est bien disponible
    if "uuid" not in st.session_state:
        st.error("Erreur : Aucun UUID trouvé. Revenez à la page précédente.")
        st.stop()

    uuid = st.session_state["uuid"]

    # Enregistrer l'heure d'affichage de la page
    if "display_time" not in st.session_state:
        st.session_state["display_time"] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # Ajouter un état pour l'envoi des données
    if "data_sent" not in st.session_state:
        st.session_state["data_sent"] = False

    # Configuration Supabase (Nouvelle table : OptimisedOldUI)
    SUPABASE_URL = "https://dlhhyjclkvsmivlhraaz.supabase.co"
    SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaGh5amNsa3ZzbWl2bGhyYWF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNzU2NjIxNiwiZXhwIjoyMDUzMTQyMjE2fQ.-bXX5wmoBZB22PXaLNcIv457ZueifpG7HZNc7tiJtrQ"

    # Création de deux colonnes pour le formulaire et l'image
    col1, col2 = st.columns([1, 1])

    # Colonne de gauche : formulaire
    with col1:
        st.title("Saisissez les données".upper())
        st.markdown("---")
        st.header("Taux")

        try:
            st.image("app4/assets/Split/Taux/Taux.jpg", use_container_width=False, width=100)
        except FileNotFoundError:
            st.warning("Image non trouvée.")
        st.markdown("")
        TAUX = st.text_input("Saisissez la donnée encadrée en vert et appuyez sur entrer", key="TAUX", autocomplete="off")

        if TAUX:

            # Capturer le datetime actuel (horodatage du moment de l'envoi)
            click_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # initialisation
            update_payload = {"TAUX": TAUX,
                              "DTT" : click_time
                              }
            endpoint = f"{SUPABASE_URL}/rest/v1/NewUI?id=eq.{uuid}"
            headers = {
                "apikey": SUPABASE_KEY,
                "Authorization": f"Bearer {SUPABASE_KEY}",
                "Content-Type": "application/json",
                "Prefer": "return=minimal"
            }

            # Envoi des données
            try:
                response = requests.patch(endpoint, json=update_payload, headers=headers)

                if response.status_code == 204:  # 204 = Modification réussie
                    st.success("Données envoyées, Votre teste est terminé. Merci !")
                    st.session_state["data_sent"] = True
                    st.session_state["page"] = "FinFormulaireComplet"  # Rediriger vers finformulaire
                    st.rerun()
                else:
                    st.error(f"Erreur lors de la mise à jour : {response.status_code}")
                    st.write("Détails :", response.text)
            except Exception as e:
                st.error(f"Erreur lors de la connexion à Supabase : {e}")

    # Affichage de l'image dans la colonne de droite
    with col2:
        try:
            st.markdown("Facture de santé")
            st.image("app4/assets/Split/Taux/SplitTaux.jpg", caption="Bloc 6 sur 6", use_container_width=True
)
        except FileNotFoundError:
            st.warning("Image non trouvée.")


____ page fin formulaire au cas ou

import streamlit as st
import requests
import datetime

# Configuration Supabase
SUPABASE_URL = "https://dlhhyjclkvsmivlhraaz.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaGh5amNsa3ZzbWl2bGhyYWF6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNzU2NjIxNiwiZXhwIjoyMDUzMTQyMjE2fQ.-bXX5wmoBZB22PXaLNcIv457ZueifpG7HZNc7tiJtrQ"

def app():
    st.title("Fin du formulaire")

    # Enregistrer l'heure d'affichage de la page
    if "DT2" not in st.session_state:
        st.session_state["DT2"] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # Vérifie que l'UUID est bien disponible
    if "uuid" not in st.session_state:
        st.error("Erreur : Aucun UUID trouvé. Revenez à la page précédente.")
        st.stop()

    uuid = st.session_state["uuid"]

    # Formulaire de feedback utilisateur
    st.write("### Indiquez votre niveau d'expérience en saisie (en mois)")
    slider_value = st.slider(
        "Nombre de mois d'expérience en saisie :",
        min_value=0,
        max_value=120,
        value=12,
        step=1
    )

    # Champs supplémentaires : Note pour l'expérience utilisateur
    st.write("### Donnez une note à votre expérience utilisateur (0 = Mauvaise, 5 = Excellente)")
    note_experience = st.radio(
        "Comment votre expérience utilisateur se compare-t-elle à vos attentes habituelles ?",
        options=[0, 1, 2, 3, 4, 5],  # Options de note de 0 à 5
        index=3  # Par défaut : 3 (convenable)
    )

    st.write("### Choisissez un pseudo si vous le souhaitez")
    pseudo = st.text_input(
        "Entrez votre pseudo :",
        placeholder="Ex: Chuck Norris"
    )

    st.write("### Laissez un commentaire concernant votre expérience :")
    commentaire = st.text_area(
        "Vos remarques ou suggestions :",
        placeholder="Votre commentaire ici..."
    )

    # Bouton pour envoyer les données à Supabase
    if st.button("Terminer"):
        update_payload = {
            "Exp": slider_value,  # Niveau d'expérience
            "Comments": commentaire,  # Commentaires
            "Pseudo": pseudo,  # Pseudo enregistré
            "Note": note_experience,  # Envoi de la note dans la colonne "Note"
            "DT2": st.session_state["DT2"]
        }

        endpoint = f"{SUPABASE_URL}/rest/v1/NewUI?id=eq.{uuid}"

        headers = {
            "apikey": SUPABASE_KEY,
            "Authorization": f"Bearer {SUPABASE_KEY}",
            "Content-Type": "application/json",
            "Prefer": "return=minimal"
        }

        # Envoi des données
        try:
            response = requests.patch(endpoint, json=update_payload, headers=headers)

            if response.status_code == 204:  # 204 = Modification réussie
                st.success("Données envoyées, Votre teste est terminé. Merci !")
            else:
                st.error(f"Erreur lors de la mise à jour : {response.status_code}")
                st.write("Détails :", response.text)
        except Exception as e:
            st.error(f"Erreur lors de la connexion à Supabase : {e}")